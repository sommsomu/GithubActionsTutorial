# This workflow deploys the application to an EC2 instance using GitHub Actions.
name: Deploy to EC2

on:
  # push:
  #   branches: [main]
  workflow_dispatch:
    
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Exit immediately on error
            REPO_DIR="/var/www/itdefined.com"
            GIT_REPO="https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git"

            # Remove existing directory (if any)
            echo "Removing old deployment..."
            sudo rm -rf "$REPO_DIR"

            # Fresh clone
            echo "Cloning fresh repository..."
            sudo mkdir -p "$REPO_DIR"
            sudo git clone "$GIT_REPO" "$REPO_DIR"

            # Set permissions
            echo "Setting permissions..."
            sudo chown -R www-data:www-data "$REPO_DIR"
            sudo find "$REPO_DIR" -type d -exec chmod 755 {} \;
            sudo find "$REPO_DIR" -type f -exec chmod 644 {} \;

            # Restart web server
            echo "Restarting nginx..."
            sudo systemctl restart nginx

            echo "Fresh deployment complete!" 